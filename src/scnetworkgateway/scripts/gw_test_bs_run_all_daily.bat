:: gw_test_bs.bat 1_NUM_WORKERS 2_MODE 3_NUM_CONNS 4_NUM_ECHOES 5_MAX_TIME_SEC 6_STATS_NAME 7_SCHED_NUM 8_APPS_MODE 9_APPS_PORT_NUM 10_NUM_CHUNKS 11_DB_OPTIONS
:: gw_test_bs.bat "1 MODE_GATEWAY_SMC_RAW 1000 10000000 100 BSStatsBlaBla" 1 MODE_GATEWAY_SMC_RAW 81 131072 --FLAG:NoDb

IF "%SC_RUN_PERFORMANCE_TESTS%"=="" GOTO :EOF

:: Building special version of Level1 solution.

"C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe" "..\..\src\Level1.sln" /p:Configuration=BuildServerTest;Platform=x64 /maxcpucount
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
CMD /C "timeout 2" 2>NUL

:: HTTP Tests

CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_HTTP 1000 10000000 100 GwSimpleHttpRPS1Worker1000Conn" 1 MODE_GATEWAY_HTTP 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_HTTP 10000 2000000 100 GwSimpleHttpRPS1Worker10000Conn" 1 MODE_GATEWAY_HTTP 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_HTTP 100000 2000000 100 GwSimpleHttpRPS1Worker100000Conn" 1 MODE_GATEWAY_HTTP 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_HTTP 1000 10000000 100 GwSimpleHttpRPS2Worker1000Conn" 2 MODE_GATEWAY_HTTP 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_HTTP 10000 2000000 100 GwSimpleHttpRPS2Worker10000Conn" 2 MODE_GATEWAY_HTTP 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_HTTP 100000 2000000 100 GwSimpleHttpRPS2Worker100000Conn" 2 MODE_GATEWAY_HTTP 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_HTTP 1002 10000000 100 GwSimpleHttpRPS3Worker1000Conn" 3 MODE_GATEWAY_HTTP 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_HTTP 10002 2000000 100 GwSimpleHttpRPS3Worker10000Conn" 3 MODE_GATEWAY_HTTP 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_HTTP 100002 2000000 100 GwSimpleHttpRPS3Worker100000Conn" 3 MODE_GATEWAY_HTTP 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_SMC_HTTP 1000 2000000 100 GwSmcSimpleHttpRPS1Worker1000Conn" 1 MODE_GATEWAY_SMC_HTTP 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_SMC_HTTP 10000 2000000 100 GwSmcSimpleHttpRPS1Worker10000Conn" 1 MODE_GATEWAY_SMC_HTTP 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_SMC_HTTP 100000 2000000 100 GwSmcSimpleHttpRPS1Worker100000Conn" 1 MODE_GATEWAY_SMC_HTTP 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_SMC_HTTP 1000 2000000 100 GwSmcSimpleHttpRPS2Worker1000Conn" 2 MODE_GATEWAY_SMC_HTTP 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_SMC_HTTP 10000 2000000 100 GwSmcSimpleHttpRPS2Worker10000Conn" 2 MODE_GATEWAY_SMC_HTTP 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_SMC_HTTP 100000 2000000 100 GwSmcSimpleHttpRPS2Worker100000Conn" 2 MODE_GATEWAY_SMC_HTTP 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_SMC_HTTP 1002 2000000 100 GwSmcSimpleHttpRPS3Worker1000Conn" 3 MODE_GATEWAY_SMC_HTTP 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_SMC_HTTP 10002 2000000 100 GwSmcSimpleHttpRPS3Worker10000Conn" 3 MODE_GATEWAY_SMC_HTTP 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_SMC_HTTP 100002 2000000 100 GwSmcSimpleHttpRPS3Worker100000Conn" 3 MODE_GATEWAY_SMC_HTTP 81 262144 --FLAG:NoDb"

:: Raw Port Tests

CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_RAW 1000 10000000 100 GwSimpleRawEchoes1Worker1000Conn" 1 MODE_GATEWAY_RAW 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_RAW 10000 2000000 100 GwSimpleRawEchoes1Worker10000Conn" 1 MODE_GATEWAY_RAW 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_RAW 100000 2000000 100 GwSimpleRawEchoes1Worker100000Conn" 1 MODE_GATEWAY_RAW 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_RAW 1000 20000000 100 GwSimpleRawEchoes2Worker1000Conn" 2 MODE_GATEWAY_RAW 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_RAW 10000 2000000 100 GwSimpleRawEchoes2Worker10000Conn" 2 MODE_GATEWAY_RAW 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_RAW 100000 2000000 100 GwSimpleRawEchoes2Worker100000Conn" 2 MODE_GATEWAY_RAW 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_RAW 1002 30000000 100 GwSimpleRawEchoes3Worker1000Conn" 3 MODE_GATEWAY_RAW 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_RAW 10002 2000000 100 GwSimpleRawEchoes3Worker10000Conn" 3 MODE_GATEWAY_RAW 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_RAW 100002 2000000 100 GwSimpleRawEchoes3Worker100000Conn" 3 MODE_GATEWAY_RAW 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_SMC_RAW 1000 2000000 100 GwSmcSimpleRawEchoes1Worker1000Conn" 1 MODE_GATEWAY_SMC_RAW 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_SMC_RAW 10000 2000000 100 GwSmcSimpleRawEchoes1Worker10000Conn" 1 MODE_GATEWAY_SMC_RAW 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "1 MODE_GATEWAY_SMC_RAW 100000 2000000 100 GwSmcSimpleRawEchoes1Worker100000Conn" 1 MODE_GATEWAY_SMC_RAW 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_SMC_RAW 1000 2000000 100 GwSmcSimpleRawEchoes2Worker1000Conn" 2 MODE_GATEWAY_SMC_RAW 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_SMC_RAW 10000 2000000 100 GwSmcSimpleRawEchoes2Worker10000Conn" 2 MODE_GATEWAY_SMC_RAW 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "2 MODE_GATEWAY_SMC_RAW 100000 2000000 100 GwSmcSimpleRawEchoes2Worker100000Conn" 2 MODE_GATEWAY_SMC_RAW 81 262144 --FLAG:NoDb"

CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_SMC_RAW 1002 2000000 100 GwSmcSimpleRawEchoes3Worker1000Conn" 3 MODE_GATEWAY_SMC_RAW 81 8192 --FLAG:NoDb"
IF %ERRORLEVEL% NEQ 0 GOTO TESTFAILED
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_SMC_RAW 10002 2000000 100 GwSmcSimpleRawEchoes3Worker10000Conn" 3 MODE_GATEWAY_SMC_RAW 81 16384 --FLAG:NoDb"
::CMD /C "gw_test_bs.bat "3 MODE_GATEWAY_SMC_RAW 100002 2000000 100 GwSmcSimpleRawEchoes3Worker100000Conn" 3 MODE_GATEWAY_SMC_RAW 81 262144 --FLAG:NoDb"

:: Killing all processes.
CMD /C "kill_all.bat" 2>NUL
GOTO :EOF

:: If we are here than some test has failed.
:TESTFAILED
ECHO Error occurred during the performance test! 1>&2
CMD /C "kill_all.bat" 2>NUL
EXIT 1